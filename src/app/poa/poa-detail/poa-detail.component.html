<app-header-app></app-header-app>
<div class="row container">
    <div class="col-md-2 p-2 d-flex justify-content-start">
        <button class="update" mat-raised-button color="primary"
            routerLink="/home-poa"> <i
                class="fa-regular fa-rectangle-list me-2"></i>Listado</button>
    </div>
</div>

<h3 class="text-center fw-bold">Detalle: {{ poaDetail.name }} - {{
    poaDetail.responsible }}</h3>

<div class="p-4">
    <div class="row">
        <div class="col-md-9">
            <!-- fomulario para actualizar POA -->
            <mat-accordion *ngIf="is_admin == false">
                <mat-expansion-panel>
                    <mat-expansion-panel-header>
                        <mat-panel-title> Actualizar POA </mat-panel-title>
                        <mat-panel-description class="update"> Click para abrir
                            POA
                        </mat-panel-description>
                        <mat-panel-description class="update">Depto. {{
                            poaDetail.department}}
                        </mat-panel-description>
                    </mat-expansion-panel-header>
                    <form (ngSubmit)="onUpdate()">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="area"
                                        class="form-label">Área:</label>
                                    <input type="text" class="form-control"
                                        name="are" [(ngModel)]="poaDetail.area">
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="ccpf"
                                        class="form-label">CCPF:</label>
                                    <input type="text" class="form-control"
                                        name="ccpf"
                                        [(ngModel)]="poaDetail.ccpf">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="name" class="form-label">N. del
                                        proyecto:</label>
                                    <input type="text" class="form-control"
                                        name="name"
                                        [(ngModel)]="poaDetail.name">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="campus"
                                        class="form-label">Campus
                                        ({{poaDetail.campus}})</label>

                                    <select class="form-select"
                                        [(ngModel)]="poaDetail.campus"
                                        name="campus">
                                        <option value="NORTH">North</option>
                                        <option value="QUITO">Quito</option>
                                        <option value="WETS">West</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="student_council"
                                        class="form-label">Consejo
                                        estudiantil:</label>
                                    <input type="text" class="form-control"
                                        name="student_council"
                                        [(ngModel)]="poaDetail.student_council">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="company"
                                        class="form-label">Empresa</label>
                                    <input type="text" class="form-control"
                                        name="company"
                                        [(ngModel)]="poaDetail.company">
                                </div>
                            </div>
                            <div class="col-md-3 d-flex justify-content-center">
                                <div class="mb-3" style="width: 100%;">
                                    <label for="status"
                                        class="form-label">Estado:</label>
                                    <select [(ngModel)]="selectedStatus"
                                        name="status" class="form-select"
                                        aria-label="Default select example">
                                        <option value>Sin cambios</option>
                                        <option *ngFor="let state of taskStates"
                                            [value]="state">{{state}}</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="objective"
                                class="form-label">Objetivo:</label>
                            <textarea class="form-control" name="objective"
                                [(ngModel)]="poaDetail.objective"></textarea>
                        </div>

                        <div class="mb-3 d-flex justify-content-evenly">
                            <button class="update" type="submit"
                                mat-raised-button
                                color="primary">Actualizar</button>
                            <a class="update" mat-raised-button
                                (click)="onCancel()">Cancelar</a>
                            <a *ngIf="poaDetail.status == 'EN PROCESO'"
                                class="update" mat-raised-button color="warn"
                                (click)="onDelete()">Eliminar POA</a>
                        </div>
                    </form>
                </mat-expansion-panel>
            </mat-accordion>
            <!-- fin fomulario para actualizar POA -->

            <!-- BOTON PARA AGREGAR ACTIVIDAD -->
            <div class="row mt-4 mb-3">
                <div class="row">
                    <div class="col-md-4 mb-3 d-flex justify-content-center"><h4
                            class="text-center">Actividades
                            ({{ allActivities?.length
                            }}):</h4></div>
                    <!-- barra de busqueda -->
                    <div class="col-md-4 mb-3">
                        <input type="text"
                            class="form-control text-center"
                            placeholder="Búsqueda por actividad o detalle de recurso"
                            [(ngModel)]="searchTerm" (input)="onSearch()">
                    </div>
                    <!-- barra de busqueda -->
                    <!-- BOTON PARA AGREGAR ACTIVIDAD -->
                    <div class="col-md-4 mb-3 d-flex justify-content-center"
                        *ngIf="poaDetail.status != 'APROBADO'">
                        <button *ngIf="is_admin == false" class="update" mat-raised-button color="primary"
                            data-bs-toggle="modal"
                            data-bs-target="#exampleModal">
                            <i class="fa-solid fa-folder-plus"></i> Agregar
                            actividad
                        </button>
                    </div>
                    <!-- BOTON PARA AGREGAR ACTIVIDAD -->
                </div>
                <div class="overflow-auto p-4" style="height: 300px;">
                    <mat-accordion>
                        <mat-expansion-panel
                            *ngFor="let activity of allActivities"
                            (click)="getActivityId(activity.id)">
                            <mat-expansion-panel-header>
                                <mat-panel-title>
                                    {{activity.activity}}
                                </mat-panel-title>
                                <mat-panel-description class="dates">
                                    Inicio: {{ activity.start_date | date }} -
                                    Fin: {{ activity.end_date | date }}
                                </mat-panel-description>
                            </mat-expansion-panel-header>
                            <div class="row">
                                <div class="col-md-12">
                                    <div
                                        *ngIf="!isEditing || editingActivityId !== activity.id">

                                        <p class="text-truncate"><strong>Detalle
                                                de recursos:</strong>
                                            {{ activity.resources_detail }}</p>

                                        <p><strong>Monto de recursos:</strong>
                                            {{ activity.resources_amount }}</p>
                                        <p
                                            class="text-truncate"
                                            matTooltip="{{activity.comments}}"
                                            *ngIf="activity.comments"><strong>Comentarios:</strong>
                                            {{
                                            activity.comments }}</p>
                                        <div *ngIf="is_admin == true">
                                            <p><strong>Monto aprobado:</strong>
                                                {{
                                                activity.approved_amount }}</p>
                                            <p><strong>Cuenta contable:</strong>
                                                {{
                                                activity.accounting_count }}</p>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            <div class="row d-flex justify-content-center">
                                <div
                                    class="col-md-6 d-flex justify-content-evenly">
                                    <div *ngIf="poaDetail.status != 'APROBADO'">
                                        <button class="update" mat-raised-button
                                        color="primary"
                                        *ngIf="!isEditing || editingActivityId !== activity.id"
                                        (click)="startEditing(activity)">Editar
                                        actividad</button>
                                    </div>
                                    <div
                                        *ngIf="poaDetail.status == 'EN PROCESO'">
                                        <button class="update" mat-raised-button
                                            *ngIf="!isEditing || editingActivityId !== activity.id "
                                            style="background-color: brown;color: white;"
                                            (click)="deleteActivity(activity.id)">Eliminar</button>
                                    </div>

                                    <a *ngIf="poaDetail.status == 'APROBADO'" class="update" mat-raised-button 
                                    (click)="downloadActivityPDF(activity); $event.stopPropagation()">PDF de la actividad</a>

                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <form
                                        *ngIf="isEditing && editingActivityId === activity.id">
                                        <div *ngIf="is_admin == false">
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <div class="mb-3">
                                                        <label for="activity"
                                                            class="form-label">Actividad:</label>
                                                        <textarea type="text"
                                                            class="form-control"
                                                            id="activity"
                                                            [(ngModel)]="editingActivity.activity"
                                                            name="activity"></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-3">
                                                    <div class="mb-3">
                                                        <label
                                                            for="resources_amount"
                                                            class="form-label">Monto
                                                            de
                                                            recursos ({{ activity.resources_amount }}$):</label>
                                                        <input type="number"
                                                            class="form-control"
                                                            id="resources_amount"
                                                            [(ngModel)]="editingActivity.resources_amount"
                                                            name="resources_amount"
                                                            maxlength="6">
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="mb-3">
                                                        <label
                                                            for="resources_amount"
                                                            class="form-label">Fecha
                                                            de inicio:</label>
                                                        <input type="date"
                                                            class="form-control"
                                                            id="resources_amount"
                                                            [(ngModel)]="editingActivity.start_date"
                                                            name="resources_amount"
                                                            maxlength="6">
                                                    </div>

                                                </div>
                                                <div class="col-md-3">

                                                    <div class="mb-3">
                                                        <label
                                                            for="resources_amount"
                                                            class="form-label">Fecha
                                                            de fin:</label>
                                                        <input type="date"
                                                            class="form-control"
                                                            id="resources_amount"
                                                            [(ngModel)]="editingActivity.end_date"
                                                            name="resources_amount"
                                                            maxlength="6">
                                                    </div>

                                                </div>
                                                <div class="col-md-3">

                                                    <div class="mb-3 ">
                                                        <label for="campus"
                                                            class="form-label">Prioridad ({{ activity.priority }}):</label>

                                                        <select
                                                            class="form-select"
                                                            [(ngModel)]="createPoa.priority"
                                                            name="campus">
                                                            <option
                                                                value="BAJA">Baja</option>
                                                            <option
                                                                value="MEDIA">Media</option>
                                                            <option
                                                                value="ALTA">Alta</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <div class="mb-3">
                                                        <label
                                                            for="resources_detail"
                                                            class="form-label">Detalle
                                                            de
                                                            recursos:</label>
                                                        <textarea
                                                            class="form-control"
                                                            id="resources_detail"
                                                            rows="3"
                                                            [(ngModel)]="editingActivity.resources_detail"
                                                            name="resources_detail"></textarea>
                                                    </div>
                                                </div>
                                                
                                            </div>
                                        </div>

                                        <!-- solo lo puede ver y modificar el; admin -->
                                        <div class="row"
                                            *ngIf="is_admin == true">
                                            <p><strong>Monto requerido:</strong>
                                                {{ activity.resources_amount
                                                }}</p>
                                            <div class="mb-3">
                                                <label for="comments"
                                                    class="form-label">Comentarios:</label>
                                                <textarea
                                                    class="form-control"
                                                    id="comments" rows="3"
                                                    [(ngModel)]="editingActivity.comments"
                                                    name="comments"></textarea>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">

                                                    <label for="approved_amount"
                                                        class="form-label">Monto
                                                        aprobado:</label>
                                                    <input type="number"
                                                        class="form-control"
                                                        id="approved_amount"
                                                        [(ngModel)]="editingActivity.approved_amount"
                                                        name="approved_amount"
                                                        maxlength="6">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label
                                                        for="accounting_count"
                                                        class="form-label">Cuenta
                                                        contable:</label>
                                                    <input type="text"
                                                        class="form-control"
                                                        id="accounting_count"
                                                        [(ngModel)]="editingActivity.accounting_count"
                                                        name="accounting_count">
                                                </div>
                                            </div>

                                        </div>
                                        <!-- solo lo puede ver y modificar el; admin -->

                                        <div
                                            class="row d-flex justify-content-center">
                                            <div
                                                class=" text-center d-flex justify-content-evenly">
                                                <button class="update"
                                                    mat-raised-button
                                                    color="primary"
                                                    *ngIf="isEditing && editingActivityId === activity.id"
                                                    (click)="saveChanges(activity.id)">Guardar</button>
                                                <button class="update"
                                                    mat-raised-button
                                                    color="secondary"
                                                    *ngIf="isEditing && editingActivityId === activity.id"
                                                    (click)="cancelEditing()">Cancelar</button>
                                                <button class="update"
                                                    mat-raised-button
                                                    *ngIf="poaDetail.status == 'EN PROCESO'"
                                                    style="background-color: brown;color: white;"
                                                    (click)="deleteActivity(activity.id)">Eliminar</button>
                                                    <a *ngIf="poaDetail.status == 'APROBADO'" class="update" mat-raised-button 
                                                    (click)="downloadActivityPDF(activity); $event.stopPropagation()">Descargar
                                                    PDF</a>
                                            </div>
                                        </div>
                                    </form>
                                    
                                </div>
                            </div>
                        </mat-expansion-panel>
                    </mat-accordion>
                </div>

                <!-- agregar fimas -->
                <!-- Button trigger modal -->
                <a *ngIf="is_admin == false" type="button" class="mb-2"
                    style="text-decoration: underline;color: black;"
                    data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                    Agregar firmas
                </a>

                <ul class="list-group" *ngFor="let sig of signaturesList">
                    <li class="list-group-item"> {{ sig.user_name }}
                        <span>{{ sig.user_email }}</span>
                        <p>{{ sig.coments }}</p></li>
                </ul>

            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center" style="color: black;">
                <i class="fa-solid fa-circle-info"></i> Manual de usuario
            </div>
            <div class="cards1 mt-2">
                <b><i class="fa-solid fa-chart-line"></i> Estadísticas de
                    Mantenimiento</b>
                <p class="text-dark">
                    La gráfica muestra el estado actual de casos
                    (iniciando, en proceso, etc.), útil para gestionar el
                    flujo de trabajo.
                </p>
            </div>
            <div class="cards1">
                <b><i class="fa-regular fa-paper-plane"></i> Creación de
                    Casos</b>
                <p class="text-dark">
                    Para crear un caso de mantenimiento u otro departamento,
                    debe ingresar al
                    proceso desde el menu izquierdo
                    <i class="fa-solid fa-bars"></i>.
                </p>
            </div>
            <div class="cards1">
                <b><i class="fa-regular fa-file-lines"></i> Obtener
                    resportería</b>
                <p class="text-dark">
                    En el menú izquierdo <i class="fa-solid fa-bars"></i>
                    podemos escoger la opción de reportería del proceso que
                    necesitemos, esto nos llevará a una nueva página para
                    visualizar la información.
                </p>
            </div>
            <div class="cards1">
                <b><i class="fa-solid fa-sliders"></i> Configuración de
                    usuario</b>
                <p class="text-dark">
                    En el menú izquierdo <i class="fa-solid fa-bars"></i>
                    podemos editar la configuración de usuario, especificamente
                    cambiar la contraseñas.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1"
    aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Agregar
                    actividad</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form (ngSubmit)="createActivity()" #activityForm="ngForm">
                    <div *ngIf="is_admin == false">
                        <div class="mb-3">
                            <label for="activity"
                                class="form-label">Actividad</label>
                            <input type="text" class="form-control"
                                id="activity"
                                [(ngModel)]="createPoa.activity" name="activity"
                                required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="start_date"
                                        class="form-label">Fecha
                                        de
                                        inicio</label>
                                    <input type="date" class="form-control"
                                        id="start_date"
                                        [(ngModel)]="createPoa.start_date"
                                        name="start_date"
                                        required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="end_date"
                                        class="form-label">Fecha
                                        de
                                        fin</label>
                                    <input type="date" class="form-control"
                                        id="end_date"
                                        [(ngModel)]="createPoa.end_date"
                                        name="end_date"
                                        required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="resources_detail"
                                class="form-label">Detalle
                                de recursos</label>
                            <textarea class="form-control"
                                id="resources_detail"
                                [(ngModel)]="createPoa.resources_detail"
                                name="resources_detail" required></textarea>
                        </div>
                        <div class="row">

                            <div class="mb-3 col-md-6">
                                <label for="resources_ammount"
                                    class="form-label">Monto
                                    de recursos</label>
                                <input maxlength="6" type="number"
                                    class="form-control"
                                    id="resources_ammount"
                                    [(ngModel)]="createPoa.resources_ammount"
                                    name="resources_ammount" required>
                            </div>

                            <div class="mb-3 col-md-6">
                                <label for="campus"
                                    class="form-label">Prioridad</label>

                                <select class="form-select"
                                    [(ngModel)]="createPoa.priority"
                                    name="campus">
                                    <option value="BAJA">Baja</option>
                                    <option value="MEDIA">Media</option>
                                    <option value="ALTA">Alta</option>
                                </select>
                            </div>

                        </div>
                    </div>

                    <!-- solo admin puede modificar -->

                    <div class="row" *ngIf="is_admin == true">
                        <div class="mb-3">
                            <label for="comments"
                                class="form-label">Comentarios</label>
                            <textarea class="form-control" id="comments"
                                [(ngModel)]="createPoa.comments"
                                name="comments"></textarea>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="accounting_calculate"
                                    class="form-label">Cuenta contable</label>
                                <input type="text" class="form-control"
                                    id="accounting_calculate"
                                    [(ngModel)]="createPoa.accounting_count"
                                    name="accounting_calculate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="approved_ammount"
                                    class="form-label">Monto
                                    aprobado</label>
                                <input maxlength="7" type="number"
                                    class="form-control"
                                    maxlength="6"
                                    id="approved_ammount"
                                    [(ngModel)]="createPoa.approved_ammount"
                                    name="approved_ammount" required>
                            </div>
                        </div>
                    </div>
                    <!-- solo admin puede modificar -->
                    <button type="submit" mat-raised-button color="primary"
                        [disabled]="activityForm.form.invalid">Crear
                        Actividad</button>
                </form>

            </div>
        </div>
    </div>
</div>

<!-- Modal firmas-->

<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static"
    data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="staticBackdropLabel">Agregar
                    firma</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for class="form-label">Asignar usuario:</label>
                        <select (change)="onUserSelect($event)"
                            [(ngModel)]="usersId" name="usuario"
                            class="form-select"
                            aria-label="Default select example">
                            <option value>Seleccione un usuario</option>
                            <option *ngFor="let user of users"
                                [value]="user.id">
                                {{ user.first_name }}
                            </option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for class="form-label">Comentario:</label>
                        <textarea class="form-control" type="text"
                            [(ngModel)]="signature.coments"
                            name="coments">
                            </textarea>
                    </div>

                    <button (click)="createSignature()" type="submit"
                        class="btn btn-primary">Enviar</button>
                </form>
            </div>

        </div>
    </div>
</div>
