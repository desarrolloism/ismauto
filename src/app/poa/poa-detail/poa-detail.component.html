<app-header-app></app-header-app>
<div class="row container">
    <div class="col-md-2 p-1 d-flex justify-content-start">
        <button matTooltip="Listado de POA" class="update" mat-raised-button
            color="primary"
            routerLink="/home-poa"> <i
                class="fa-regular fa-rectangle-list me-2"></i>POAS</button>
    </div>
</div>

<h3 class="text-center fw-bold">POA: {{ poaDetail.name }} - {{
    poaDetail.responsible }} - <span class="text-secondary">
        {{poaDetail.status}}</span><span class="text-secondary"> - Total
        requerido: {{
        poaDetail.total_resources }}$ - Total aprobado: {{
        poaDetail.total_aproved }}$</span></h3>

<div class="container">
    <div class="row">
        <div class="col-md-12">
            <!-- fomulario para actualizar POA -->
            <mat-accordion class="custom-shadow-panel">
                <mat-expansion-panel>
                    <mat-expansion-panel-header>
                        <mat-panel-title> Actualizar POA </mat-panel-title>
                        <mat-panel-description class="update"> Click para abrir
                            POA
                        </mat-panel-description>
                        <mat-panel-description class="update">Depto. {{
                            poaDetail.department}}
                        </mat-panel-description>
                    </mat-expansion-panel-header>
                    <div class="mb-3 admin" *ngIf="is_admin == true">
                        <div class="row">
                            <div class="col-md-4">
                                <h4>Área: <span>{{poaDetail.area}}</span></h4>
                            </div>
                            <div class="col-md-4">
                                <h4>CCPF: <span>{{poaDetail.ccpf}}</span></h4>
                            </div>
                            <div class="col-md-4">
                                <h4>Nombre del proyecto:
                                    <span>{{poaDetail.name}}</span></h4>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <h4>Campus:
                                    <span>{{poaDetail.campus}}</span></h4>
                            </div>
                            <div class="col-md-4">
                                <h4>Consejo estudiantil:
                                    <span>{{poaDetail.student_council}}</span></h4>
                            </div>
                            <div class="col-md-4">
                                <h4>Empresa:
                                    <span>{{poaDetail.enterprise}}</span></h4>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <h4>Objetivo:
                                    <span>{{poaDetail.objective}}</span></h4>
                            </div>
                        </div>

                        <div class="col-md-12 d-flex justify-content-center">
                            <div class="mb-3" style="width: 30%;"
                                *ngIf="poaDetail.status != 'APROBADO'">
                                <label for="status"
                                    class="form-label">Estado:</label>
                                <select (change)="onUpdate()"
                                    [(ngModel)]="selectedStatus"
                                    name="status" class="form-select"
                                    aria-label="Default select example">
                                    <option *ngFor="let state of taskStates"
                                        [value]="state">{{state}}</option>
                                </select>
                            </div>
                        </div>

                    </div>

                    <form (ngSubmit)="onUpdate()" *ngIf="is_admin == false">
                        <h2>Formulario de actualización de POA </h2>

                        <hr>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="area"
                                        class="form-label">Área:</label>
                                    <input type="text" class="form-control"
                                        name="are" [(ngModel)]="poaDetail.area">
                                </div>

                            </div>

                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="ccpf"
                                        class="form-label">CCPF:</label>
                                    <input type="text" class="form-control"
                                        name="ccpf"
                                        [(ngModel)]="poaDetail.ccpf">
                                </div>

                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="name" class="form-label">N. del
                                        proyecto:</label>
                                    <input type="text" class="form-control"
                                        name="name"
                                        [(ngModel)]="poaDetail.name">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="campus"
                                        class="form-label">Campus
                                        ({{poaDetail.campus}})</label>

                                    <select class="form-select"
                                        [(ngModel)]="poaDetail.campus"
                                        name="campus">
                                        <option value="NORTH">North</option>
                                        <option value="QUITO">Quito</option>
                                        <option value="WETS">West</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="student_council"
                                        class="form-label">Consejo
                                        estudiantil:</label>
                                    <input type="text" class="form-control"
                                        name="student_council"
                                        [(ngModel)]="poaDetail.student_council">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="company"
                                        class="form-label">Empresa</label>
                                    <input type="text" class="form-control"
                                        name="company"
                                        [(ngModel)]="poaDetail.company">
                                </div>
                            </div>

                        </div>
                        <div class="mb-3">
                            <label for="objective"
                                class="form-label">Objetivo:</label>
                            <textarea class="form-control" name="objective"
                                [(ngModel)]="poaDetail.objective"></textarea>
                        </div>

                        <div class="mb-3 d-flex justify-content-evenly">
                            <button class="update" type="submit"
                                mat-raised-button
                                color="primary">Actualizar</button>
                            <!-- <a class="update" mat-raised-button
                                (click)="onCancel()">Cancelar</a> -->
                            <a *ngIf="poaDetail.status != 'APROBADO'"
                                class="update" mat-raised-button color="warn"
                                (click)="onDelete()">Eliminar POA</a>
                        </div>
                    </form>
                </mat-expansion-panel>
            </mat-accordion>

            <!-- fin fomulario para actualizar POA -->

            <!-- BOTON PARA AGREGAR ACTIVIDAD -->
            <div class="row mt-4 mb-3">
                <div class="row">
                    <div class="col-md-4 mb-3 d-flex justify-content-center"><h4
                            class="text-center"><i
                                class="fa-regular fa-clipboard me-2"></i>Actividades
                            ({{ allActivities?.length
                            }}):</h4></div>
                    <!-- barra de busqueda -->
                    <div class="col-md-4 mb-3">
                        <input type="text" style="border-radius: 50px;"
                            class="form-control text-center"
                            placeholder="Búsqueda por actividad o detalle de recurso"
                            [(ngModel)]="searchTerm" (input)="onSearch()">
                    </div>
                    <!-- barra de busqueda -->
                    <!-- BOTON PARA AGREGAR ACTIVIDAD -->
                    <div class="col-md-4 mb-3 d-flex justify-content-center"
                        *ngIf="poaDetail.status != 'APROBADO'">
                        <button class="update"
                            mat-raised-button color="primary"
                            data-bs-toggle="modal"
                            data-bs-target="#exampleModal">
                            <i class="fa-solid fa-folder-plus"></i> Agregar
                            actividad
                        </button>
                    </div>
                    <!-- BOTON PARA AGREGAR ACTIVIDAD -->
                </div>

                <!-- TABLA DE ACTIVIDADES -->
                <div class="overflow-auto p-2">
                    <mat-accordion class="custom-shadow-panel">
                        <mat-expansion-panel
                            *ngFor="let activity of allActivities"
                            (click)="getActivityId(activity.id)">
                            <mat-expansion-panel-header
                                style="background-color: rgb(109, 121, 121)">
                                <mat-panel-title>
                                    <p matTooltip="{{activity.activity}}"
                                        class="truncate text-white"><i
                                            class="fa-regular fa-clipboard me-2"></i>{{activity.activity}}</p>
                                </mat-panel-title>
                                <mat-panel-description class="dates text-white">
                                    <i
                                        class="fa-regular fa-calendar me-2"></i>Inicio:
                                    {{ activity.start_date | date }} -
                                    Fin: {{ activity.end_date | date }} <i
                                        class="fa-solid fa-calendar-check ms-2"></i>
                                </mat-panel-description>
                                <mat-panel-description class="dates">
                                    <i
                                        class="fa-solid fa-file-invoice-dollar me-2"></i>Monto
                                    requerido: {{
                                    activity.resources_amount }}$ -
                                    <span
                                        *ngIf="activity.approved_amount != '0.00'"
                                        class="text-white"
                                        style="margin-left: 5px;">
                                        Monto aprobado: {{
                                        activity.approved_amount }}$ <i
                                            class="fa-regular fa-circle-check"></i>
                                    </span>
                                    <span
                                        *ngIf="activity.approved_amount == '0.00'"
                                        class="p-1 bg-white progress-container fw-bold"
                                        style="border-radius: 10px; margin-left: 5px;">
                                        En revisión
                                        <mat-progress-bar mode="buffer"
                                            class="progress-bar"></mat-progress-bar>

                                    </span>

                                </mat-panel-description>
                            </mat-expansion-panel-header>
                            <div class="row">
                                <div class="col-md-12 mt-4">
                                    <div
                                        *ngIf="!isEditing || editingActivityId !== activity.id">

                                        <p><strong
                                                matTooltip="{{activity.activity}}"><i
                                                    class="fa-regular fa-clipboard me-2"></i>
                                                Actividad:</strong>
                                            {{ activity.activity }}</p>

                                        <p><strong><i
                                                    class="fa-solid fa-info me-2"></i>
                                                Detalle
                                                de recursos:</strong>
                                            {{ activity.resources_detail }}</p>

                                        <p><strong><i
                                                    class="fa-solid fa-file-invoice-dollar me-2"></i>
                                                Monto de recursos:</strong>
                                            {{ activity.resources_amount }}</p>
                                        <p
                                            *ngIf="activity.approved_amount != '0.00'"><strong><i
                                                    class="fa-regular fa-circle-check me-2"></i>Monto
                                                aprobado:</strong>
                                            {{ activity.approved_amount }}</p>

                                        <p
                                            *ngIf="activity.comments"><strong
                                                matTooltip="{{activity.comments}}">Comentarios:</strong>
                                            {{
                                            activity.comments }}</p>
                                        <p
                                            *ngIf="activity.accounting_count"><strong>Cuenta
                                                contable:</strong>
                                            {{ activity.accounting_count }}</p>
                                        <div *ngIf="is_admin == true">
                                            <p><strong>Monto aprobado:</strong>
                                                {{
                                                activity.approved_amount }}</p>
                                            <p><strong>Cuenta contable:</strong>
                                                {{
                                                activity.accounting_count }}</p>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            <div class="row d-flex justify-content-center">
                                @if (signaturesList?.length == 1 && is_admin ==
                                false && activity.approved_amount == '0.00') {
                                <div class="alert alert-secondary" role="alert">
                                    Se ha enviado a su jefe directo para
                                    aprobación
                                    <mat-progress-bar
                                        mode="indeterminate"></mat-progress-bar>

                                </div>
                                <div class="row d-flex justify-content-center">
                                    <div style="width: 30%;">
                                        <a
                                            class="update bg-success text-white"
                                            mat-raised-button
                                            (click)="downloadActivityPDF(activity); $event.stopPropagation()">
                                            Descarga PDF
                                            de la actividad!</a>
                                    </div>
                                </div>

                                } @else{
                                <div
                                    class="col-md-6 d-flex justify-content-evenly">
                                    @if (activity.approved_amount == '0.00') {
                                    <div
                                        *ngIf="poaDetail.status != 'APROBADO' ">
                                        <button class="update" mat-raised-button
                                            color="primary"
                                            *ngIf="!isEditing || editingActivityId !== activity.id"
                                            (click)="startEditing(activity)">Editar
                                            actividad</button>
                                    </div>
                                    <div
                                    *ngIf="poaDetail.status != 'APROBADO'">
                                        <button class="update" mat-raised-button
                                            *ngIf="!isEditing || editingActivityId !== activity.id "
                                            style="background-color: brown;color: white;"
                                            (click)="deleteActivity(activity.id)">Eliminar</button>
                                    </div>
                                    } @else {

                                    }
                                    @if (activity.approved_amount != '0.00' ||
                                    poaDetail.status == 'APROBADO') {
                                    <a class="update bg-success text-white"
                                        mat-raised-button
                                        (click)="downloadActivityPDF(activity); $event.stopPropagation()">
                                        Descarga PDF
                                        de la actividad!</a>
                                    }
                                </div>
                                }

                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <form
                                        *ngIf="isEditing && editingActivityId === activity.id">
                                        <div *ngIf="is_admin == false">
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <div class="mb-3">
                                                        <label for="activity"
                                                            class="form-label">Actividad:</label>
                                                        <textarea type="text"
                                                            class="form-control"
                                                            id="activity"
                                                            [(ngModel)]="editingActivity.activity"
                                                            name="activity"></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-3">
                                                    <div class="mb-3">
                                                        <label
                                                            for="resources_amount"
                                                            class="form-label">Monto
                                                            de
                                                            recursos ({{
                                                            activity.resources_amount
                                                            }}$):</label>
                                                        <input type="number"
                                                            class="form-control"
                                                            id="resources_amount"
                                                            [(ngModel)]="editingActivity.resources_amount"
                                                            name="resources_amount"
                                                            maxlength="6">
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="mb-3">
                                                        <label
                                                            for="resources_amount"
                                                            class="form-label">Fecha
                                                            de inicio
                                                            ({{activity.start_date
                                                            | date}}):</label>
                                                        <input type="date"
                                                            class="form-control"
                                                            id="resources_amount"
                                                            [(ngModel)]="editingActivity.start_date"
                                                            name="resources_amount"
                                                            maxlength="6">
                                                    </div>

                                                </div>
                                                <div class="col-md-3">

                                                    <div class="mb-3">
                                                        <label
                                                            for="resources_amount"
                                                            class="form-label">Fecha
                                                            de fin
                                                            ({{activity.end_date
                                                            | date}}):</label>
                                                        <input type="date"
                                                            class="form-control"
                                                            id="resources_amount"
                                                            [(ngModel)]="editingActivity.end_date"
                                                            name="resources_amount"
                                                            maxlength="6">
                                                    </div>

                                                </div>
                                                <div class="col-md-3">

                                                    <div class="mb-3 ">
                                                        <label for="campus"
                                                            class="form-label">Prioridad
                                                            ({{
                                                            activity.priority
                                                            }}):</label>

                                                        <select
                                                            class="form-select"
                                                            [(ngModel)]="createPoa.priority"
                                                            name="campus">
                                                            <option
                                                                value="BAJA">Baja</option>
                                                            <option
                                                                value="MEDIA">Media</option>
                                                            <option
                                                                value="ALTA">Alta</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <div class="mb-3">
                                                        <label
                                                            for="resources_detail"
                                                            class="form-label">Detalle
                                                            de
                                                            recursos:</label>
                                                        <textarea
                                                            class="form-control"
                                                            id="resources_detail"
                                                            rows="3"
                                                            [(ngModel)]="editingActivity.resources_detail"
                                                            name="resources_detail"></textarea>
                                                    </div>
                                                </div>

                                            </div>
                                        </div>

                                        <!-- solo lo puede ver y modificar el; admin -->
                                        <div class="row"
                                            *ngIf="is_admin == true">
                                            <p><strong>Monto requerido:</strong>
                                                {{ activity.resources_amount
                                                }}</p>
                                            <div class="mb-3">
                                                <label for="comments"
                                                    class="form-label">Comentarios:</label>
                                                <textarea
                                                    class="form-control"
                                                    id="comments" rows="3"
                                                    [(ngModel)]="editingActivity.comments"
                                                    name="comments"></textarea>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">

                                                    <label for="approved_amount"
                                                        class="form-label">Monto
                                                        aprobado:</label>
                                                    <input type="number"
                                                        class="form-control"
                                                        id="approved_amount"
                                                        [(ngModel)]="editingActivity.approved_amount"
                                                        name="approved_amount"
                                                        maxlength="6">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label
                                                        for="accounting_count"
                                                        class="form-label">Cuenta
                                                        contable:</label>
                                                    <input type="text"
                                                        class="form-control"
                                                        id="accounting_count"
                                                        [(ngModel)]="editingActivity.accounting_count"
                                                        name="accounting_count">
                                                </div>
                                            </div>

                                        </div>
                                        <!-- solo lo puede ver y modificar el; admin -->

                                        <div
                                            class="row d-flex justify-content-center">
                                            <div
                                                class=" text-center d-flex justify-content-evenly">
                                                <button class="update"
                                                    mat-raised-button
                                                    color="primary"
                                                    *ngIf="isEditing && editingActivityId === activity.id"
                                                    (click)="saveChanges(activity.id)">Guardar</button>
                                                <button class="update"
                                                    mat-raised-button
                                                    color="secondary"
                                                    *ngIf="isEditing && editingActivityId === activity.id"
                                                    (click)="cancelEditing()">Cancelar</button>
                                                <button class="update"
                                                    mat-raised-button
                                                    *ngIf="poaDetail.status != 'APROBADO'"
                                                    style="background-color: brown;color: white;"
                                                    (click)="deleteActivity(activity.id)">Eliminar</button>
                                                <a
                                                    *ngIf="poaDetail.status == 'APROBADO' "
                                                    class="update"
                                                    mat-raised-button
                                                    (click)="downloadActivityPDF(activity); $event.stopPropagation()">Descargar
                                                    PDF</a>
                                            </div>
                                        </div>
                                    </form>

                                </div>
                            </div>
                        </mat-expansion-panel>
                    </mat-accordion>
                </div>

                <!-- agregar fimas -->
                <!-- Button trigger modal -->
                @if( signaturesList?.length == 1 && is_admin == false) {
                <div class="alert alert-success" role="alert">
                    Se ha enviado a su jefe directo para
                    aprobación<i class="fa-solid fa-user-check ms-2"></i>
                </div>

                <ul class="list-group" *ngFor="let sig of signaturesList">
                    <li class="list-group-item"><b>Jefe directo:</b> {{
                        sig.user_name }}
                        <span>{{ sig.user_email }}</span>
                        <p>{{ sig.coments }}</p>
                    </li>
                </ul>
                } @else {
                <div style="width: 30%;">
                    <a mat-raised-button *ngIf="is_admin == false" type="button"
                        class="mb-2 bg-success text-white"
                        data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                        Enviar POA
                    </a>
                </div>
                }

            </div>
        </div>

    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1"
    aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Agregar
                    actividad</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form (ngSubmit)="createActivity()" #activityForm="ngForm">
                    <div *ngIf="is_admin == false">
                        <div class="mb-3">
                            <label for="activity"
                                class="form-label">Actividad</label>
                            <input type="text" class="form-control"
                                id="activity"
                                [(ngModel)]="createPoa.activity" name="activity"
                                required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="start_date"
                                        class="form-label">Fecha
                                        de
                                        inicio</label>
                                    <input type="date" class="form-control"
                                        id="start_date"
                                        [(ngModel)]="createPoa.start_date"
                                        name="start_date"
                                        required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="end_date"
                                        class="form-label">Fecha
                                        de
                                        fin</label>
                                    <input type="date" class="form-control"
                                        id="end_date"
                                        [(ngModel)]="createPoa.end_date"
                                        name="end_date"
                                        required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="resources_detail"
                                class="form-label">Detalle
                                de recursos</label>
                            <textarea class="form-control"
                                id="resources_detail"
                                [(ngModel)]="createPoa.resources_detail"
                                name="resources_detail" required></textarea>
                        </div>
                        <div class="row">

                            <div class="mb-3 col-md-6">
                                <label for="resources_ammount"
                                    class="form-label">Monto
                                    de recursos</label>
                                <input maxlength="6" type="number"
                                    class="form-control"
                                    id="resources_ammount"
                                    [(ngModel)]="createPoa.resources_ammount"
                                    name="resources_ammount" required>
                            </div>

                            <div class="mb-3 col-md-6">
                                <label for="campus"
                                    class="form-label">Prioridad</label>

                                <select class="form-select"
                                    [(ngModel)]="createPoa.priority"
                                    name="campus">
                                    <option value="BAJA">Baja</option>
                                    <option value="MEDIA">Media</option>
                                    <option value="ALTA">Alta</option>
                                </select>
                            </div>

                        </div>
                    </div>

                    <!-- solo admin puede modificar -->

                    <div class="row" *ngIf="is_admin == true">
                        <div class="mb-3">
                            <label for="comments"
                                class="form-label">Comentarios</label>
                            <textarea class="form-control" id="comments"
                                [(ngModel)]="createPoa.comments"
                                name="comments"></textarea>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="accounting_calculate"
                                    class="form-label">Cuenta contable</label>
                                <input type="text" class="form-control"
                                    id="accounting_calculate"
                                    [(ngModel)]="createPoa.accounting_count"
                                    name="accounting_calculate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="approved_ammount"
                                    class="form-label">Monto
                                    aprobado</label>
                                <input maxlength="7" type="number"
                                    class="form-control"
                                    maxlength="6"
                                    id="approved_ammount"
                                    [(ngModel)]="createPoa.approved_ammount"
                                    name="approved_ammount" required>
                            </div>
                        </div>
                    </div>
                    <!-- solo admin puede modificar -->
                    <button type="submit" mat-raised-button color="primary"
                        [disabled]="activityForm.form.invalid">Crear
                        Actividad</button>
                </form>

            </div>
        </div>
    </div>
</div>

<!-- Modal firmas-->

<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static"
    data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="staticBackdropLabel">Agregar
                    jefe directo</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for class="form-label">Asignar usuario:</label>
                        <!-- <select (change)="onUserSelect($event)"
                            [(ngModel)]="usersId" name="usuario"
                            class="form-select"
                            aria-label="Default select example">
                            <option value>Seleccione un usuario</option>
                            <option *ngFor="let user of users"
                                [value]="user.id">
                                {{ user.first_name }}
                            </option>
                        </select> -->
                        <div class="mb-3" style="width: 30%;"
                            *ngIf="poaDetail.status != 'APROBADO'">
                            <label for="status"
                                class="form-label">Estado:</label>
                            <select (change)="onUpdate()"
                                [(ngModel)]="selectedStatus"
                                name="status" class="form-select"
                                aria-label="Default select example">
                                <option *ngFor="let user of users"
                                    [value]="user.first_name">
                                    {{ user.first_name }}
                                </option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for class="form-label">Comentario:</label>
                        <textarea class="form-control" type="text"
                            [(ngModel)]="signature.coments"
                            name="coments">
                            </textarea>
                    </div>

                    <button (click)="createSignature()" type="submit"
                        class="btn btn-primary">Enviar</button>
                </form>
            </div>

        </div>
    </div>
</div>
